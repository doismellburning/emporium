{% extends "base.html" %}

{% block content %}
	{% if user.is_authenticated %}
		<h2>Add Package</h2>
		<form action="{% url 'add-package' %}" method="POST">{% csrf_token %}
			{{ add_package_form.as_p }}
			<input type="submit" value="Add Package">
		</form>
	{% endif %}

	{% if user.is_authenticated %}
		<form action="{% url 'fetch-latest-package-versions' %}" method="POST">{% csrf_token %}
			<input type="submit" value="Fetch ALL latest package versions">
		</form>
	{% endif %}

	<table>
		{% for package in package_list %}
			<tr>
				<td><a href="{% url 'package' name=package.name %}">{{ package }}</a></td>
				<td>
					<ul>
						{% for pv in package.packageversion_set.all %}
							<li>{{ pv.version }}</li>
							{% if user.is_authenticated %}
								<li>
									<form action="{% url 'fetch-latest-package-version' pk=package.id %}" method="post">
										{% csrf_token %}
										<input type="submit" value="Fetch latest package version" />
									</form>
								</li>
							{% endif %}
						{% endfor %}
					</ul>
				</td>
				{% with package.get_latest_version as pv %}
					<td>{{ pv.version }}</td>
					{% if user.is_authenticated %}
						<td>
							{% if not pv.fetched %}
								<form action="{% url 'fetch-setuppy' name=package.name version=pv.version %}" method="post">
									{% csrf_token %}
									<input type="submit" value="Fetch setup.py" />
								</form>
							{% endif %}
						</td>
						<td>
							{% if pv.fetched %}
								<form action="{% url 'parse-setuppy' name=package.name version=pv.version %}" method="post">
									{% csrf_token %}
									<input type="submit" value="Parse setup.py" />
								</form>
							{% endif %}
						</td>
					{% endif %}
					<td>
						<ul>
							{% for dependency in pv.dependency_set.all %}
								<li>{{ dependency.package.name }} (<code>{{ dependency.specification }}</code>)</li>
							{% endfor %}
						</ul>
					</td>
				{% endwith %}
			</tr>
		{% endfor %}
	</table>
{% endblock %}
